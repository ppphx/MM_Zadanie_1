import numpy as np
import matplotlib.pyplot as plt

# 1. Теоретические расчёты
lambda_ = 1.0  # интенсивность потока (авт/час)
t_obsl_srednee = 1.8  # среднее время обслуживания (часы)
mu = 1 / t_obsl_srednee  # интенсивность обслуживания (авт/час)

print("ЗАДАЧА 1: Одноканальная СМО с отказами")
print("\n1. Определение предельных значений в установившемся режиме:")

P_otk_theory = lambda_ / (lambda_ + mu)
Q_theory = mu / (lambda_ + mu)
A_theory = lambda_ * Q_theory

print(f"Относительная пропускная способность Q = {Q_theory:.4f}")
print(f"Абсолютная пропускная способность A = {A_theory:.4f}")
print(f"Вероятность отказа P_отк = {P_otk_theory:.4f}")

print("\n2. Сравнение с номинальной пропускной способностью:")
A_nominal = mu
print(f"Номинальная пропускная способность: {A_nominal:.4f}")
print(f"Фактическая пропускная способность: {A_theory:.4f}")
print(f"Потери из-за отказов: {A_nominal - A_theory:.4f}")
print(f"Относительные потери: {100 * (A_nominal - A_theory) / A_nominal:.1f}%")


# 3. Функция для моделирования СМО
def rn_post():
    """Функция для моделирования поступления заявок"""
    return np.random.randint(1, 61)


def simulate_smo(T_minutes, use_poisson=True):
    """
    Моделирование работы СМО в течение T_minutes минут
    Возвращает: post, otk, obsl
    use_poisson: True -> время обслуживания ~ Poisson(108), False -> ~ Exponential(108)
    """
    post = 0
    otk = 0
    obsl = 0
    t_okon = 0

    for t in range(T_minutes):
        # Моделирование поступления заявок
        k1 = rn_post()
        if k1 == 1:
            post += 1

            if t_okon == 0:  # канал свободен
                obsl += 1
                # Время обслуживания
                if use_poisson:
                    time_obsl = np.random.poisson(108)  # Пуассон с мат. ожиданием 108 мин
                else:
                    time_obsl = int(max(1, np.random.exponential(108)))  # Экспоненциальное
                if time_obsl < 1:
                    time_obsl = 1
                t_okon = time_obsl
            else:  # канал занят
                otk += 1

        if t_okon > 0:
            t_okon -= 1

    return post, otk, obsl


# 4. Однократное моделирование
print("\nОднократное моделирование:")
T_minutes = 480  # продолжительность работы СМО (8 часов)

post, otk, obsl = simulate_smo(T_minutes, use_poisson=True)

P_otk_exp = otk / post if post > 0 else 0
Q_exp = obsl / post if post > 0 else 0
A_exp = obsl / (T_minutes / 60)  # авт/час

print(f"Время моделирования: {T_minutes} минут ({T_minutes / 60:.1f} часов)")
print(f"Поступило заявок (post): {post}")
print(f"Обслужено заявок (obsl): {obsl}")
print(f"Отказов (otk): {otk}")
print(f"Вероятность отказа (эксперимент): {P_otk_exp:.4f}")
print(f"Относительная пропускная способность (эксперимент): {Q_exp:.4f}")
print(f"Абсолютная пропускная способность (эксперимент): {A_exp:.4f}")

# 5. Многократное моделирование (50 и 1000 повторов)
print("\nМногократное моделирование:")

n_repeats_list = [50, 1000]
results = {}

for n_repeats in n_repeats_list:
    P_otk_list = []
    Q_list = []
    A_list = []

    for i in range(n_repeats):
        post, otk, obsl = simulate_smo(T_minutes, use_poisson=True)

        if post > 0:
            P_otk_exp = otk / post
            Q_exp = obsl / post
        else:
            P_otk_exp = 0
            Q_exp = 0

        A_exp = obsl / (T_minutes / 60)

        P_otk_list.append(P_otk_exp)
        Q_list.append(Q_exp)
        A_list.append(A_exp)

    # Средние значения
    P_otk_avg = np.mean(P_otk_list)
    Q_avg = np.mean(Q_list)
    A_avg = np.mean(A_list)

    results[n_repeats] = {
        'P_otk_avg': P_otk_avg,
        'Q_avg': Q_avg,
        'A_avg': A_avg
    }

    print(f"\nСредняя вероятность отказа ({n_repeats} повторов): {P_otk_avg:.4f}")
    print(f"Средняя относительная пропускная способность ({n_repeats} повторов): {Q_avg:.4f}")
    print(f"Средняя абсолютная пропускная способность ({n_repeats} повторов): {A_avg:.4f}")

# 6. Проверка сходимости
print("\nПроверка сходимости статистических оценок к теоретическим значениям:")
for n_repeats in n_repeats_list:
    avg = results[n_repeats]
    print(f"\n{n_repeats} повторов:")
    print(f"  Теоретическое P_отк: {P_otk_theory:.4f}, Экспериментальное: {avg['P_otk_avg']:.4f}")
    print(f"  Теоретическое Q: {Q_theory:.4f}, Экспериментальное: {avg['Q_avg']:.4f}")
    print(f"  Теоретическое A: {A_theory:.4f}, Экспериментальное: {avg['A_avg']:.4f}")

# 7. График зависимости P_отк от времени обслуживания
print("\nПостроение графика зависимости P_отк от времени обслуживания...")

# Диапазон среднего времени обслуживания (в часах)
T_obsl_range = np.linspace(0.5, 3.0, 10)
P_otk_theory_list = []
P_otk_exp_poisson_list = []
P_otk_exp_exp_list = []

for T_obsl in T_obsl_range:
    mu_val = 1 / T_obsl
    # Теория (M/M/1/0)
    P_otk_theory_val = lambda_ / (lambda_ + mu_val)
    P_otk_theory_list.append(P_otk_theory_val)

    # Эксперимент с Пуассоновским временем обслуживания
    P_otk_exp_poisson_vals = []
    for _ in range(50):  # 50 прогонов для усреднения
        post, otk, obsl = simulate_smo(T_minutes, use_poisson=True)
        if post > 0:
            P_otk_exp_poisson_vals.append(otk / post)
    P_otk_exp_poisson_list.append(np.mean(P_otk_exp_poisson_vals))

    # Эксперимент с Экспоненциальным временем обслуживания
    P_otk_exp_exp_vals = []
    for _ in range(50):  # 50 прогонов для усреднения
        post, otk, obsl = simulate_smo(T_minutes, use_poisson=False)
        if post > 0:
            P_otk_exp_exp_vals.append(otk / post)
    P_otk_exp_exp_list.append(np.mean(P_otk_exp_exp_vals))

# Построение графика
plt.figure(figsize=(10, 6))
plt.plot(T_obsl_range, P_otk_theory_list, 'b-', linewidth=2, label='Теория (M/M/1/0)')
plt.plot(T_obsl_range, P_otk_exp_poisson_list, 'ro', markersize=6, label='Эксперимент (Пуассон)')
plt.plot(T_obsl_range, P_otk_exp_exp_list, 'gs', markersize=6, label='Эксперимент (Экспоненциальное)')
plt.xlabel('Среднее время обслуживания (часы)')
plt.ylabel('Вероятность отказа $P_{отк}$')
plt.title('Зависимость вероятности отказа от времени обслуживания\n(Одноканальная СМО с отказами)')
plt.legend()
plt.grid(True, linestyle='--', alpha=0.7)
plt.tight_layout()
plt.show()
